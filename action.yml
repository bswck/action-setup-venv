name: 'venv setup'
description: 'configures venv, python and caches'

inputs:
  python-version:
    description: "Version range or exact version of Python or PyPy to use, using SemVer's version range syntax."
    required: true
  requirement-files:
    description: "Requirement files to install. Can be a glob pattern."
    required: true

runs:
  using: 'composite'
  steps:
    - name: Setup python
      uses: actions/setup-python@13ae5bb136fac2878aff31522b9efb785519f984  # v4.3.0
      with:
        python-version: ${{ inputs.python-version }}

    - name: Setup action variables
      id: venv
      shell: bash
      run: |
        echo "::group::Setup action variables"
        python3 -uS ${{ github.action_path }}/bin/setup-venv vars \
        --python-version ${{ inputs.python-version }} \
        --requirement-files-hash ${{ hashFiles(inputs.requirement-files) }}
        echo "::endgroup::"

    - name: Cache venv
      id: cache-venv
      uses: actions/cache@v3
      with:
        path: ${{ steps.venv.outputs.venv-dir }}
        key: ${{ steps.venv.outputs.cache-key }}

    - name: Create venv
      if: steps.cache-venv.outputs.cache-hit != 'true'
      shell: bash
      run: |
        echo "::group::Creating virtual environment"
        python3 -m venv ${{ steps.venv.outputs.venv-dir }} && source ${{ steps.venv.outputs.venv-dir }}/bin/activate
        echo "::endgroup::"

    - name: Pip install
      shell: bash
      run: |
        echo "::group::Running pip install"
        pip install -r ${{ inputs.requirement-files }}
        echo "::endgroup::"

    # - name: Cache venv
